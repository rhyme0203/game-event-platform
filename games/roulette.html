<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ°</text></svg>">
  <title>ëŸ­í‚¤ë¹¤ì“° - í–‰ìš´ì˜ ë£°ë ›</title>
  <link rel="stylesheet" href="../assets/css/common.css">
  <link rel="stylesheet" href="../assets/css/ads.css">
  <link rel="stylesheet" href="../assets/css/ad-modal.css">
  <link rel="stylesheet" href="../assets/css/point-system.css">
  
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8451876651536601" crossorigin="anonymous"></script>
  
  <style>
    body {
      background: white !important;
      margin: 0;
      padding: 0;
    }

    .roulette-container {
      position: relative;
      width: 400px;
      height: 400px;
      margin: 0 auto;
    }

    .roulette-wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      position: relative;
      transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
      border: 8px solid #333;
      overflow: hidden;
    }

    .roulette-wheel.spinning {
      animation: spin 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(1800deg); }
    }

    .roulette-pointer {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-bottom: 30px solid #333;
      z-index: 10;
    }

    .roulette-segment {
      position: absolute;
      width: 50%;
      height: 50%;
      transform-origin: 100% 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
      font-size: 12px;
      text-align: center;
      padding: 10px;
      box-sizing: border-box;
    }

    .info-section {
      margin: 20px 0;
      text-align: center;
    }

    .attempts-info {
      font-size: 18px;
      margin: 15px 0;
      color: #333;
    }

    .attempts-number {
      color: #667eea;
      font-weight: bold;
    }

    .start-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: block;
      margin: 20px auto;
      text-align: center;
    }

    .start-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .start-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .result-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
    }

    .result-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      max-width: 300px;
      width: 90%;
    }

    .result-prize {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin: 20px 0;
    }

    .result-actions {
      margin-top: 20px;
    }

    .result-actions button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      margin: 0 5px;
    }

    .ad-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
    }

    .ad-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      max-width: 300px;
      width: 90%;
    }

    .ad-placeholder {
      background: #f0f0f0;
      height: 250px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px dashed #ccc;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="game-container">
    <h1>ğŸ° í–‰ìš´ì˜ ë£°ë ›</h1>
    
    <div class="roulette-container">
      <div class="roulette-wheel" id="rouletteWheel">
        <div class="roulette-pointer"></div>
      </div>
    </div>
    
    <div class="info-section">
      <div class="attempts-info">
        ë‚¨ì€ ê¸°íšŒ: <span class="attempts-number" id="remainingAttempts">3</span>íšŒ
      </div>
      
      <button class="start-button" id="spinBtn" onclick="showAdModal()">ë£°ë › ëŒë¦¬ê¸°</button>
    </div>
  </div>
  
  <!-- ê²°ê³¼ ëª¨ë‹¬ -->
  <div class="result-modal" id="resultModal">
    <div class="result-content">
      <h2>ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤!</h2>
      <div class="result-prize" id="resultPrize"></div>
      <div class="result-actions">
        <button onclick="closeResultModal()">í™•ì¸</button>
        <button onclick="showAdModal()">ê´‘ê³  ë³´ê¸°</button>
      </div>
    </div>
  </div>
  
  <!-- ê´‘ê³  ëª¨ë‹¬ -->
  <div class="ad-modal" id="adModal">
    <div class="ad-content">
      <h3>ê´‘ê³ ë¥¼ ì‹œì²­í•´ì£¼ì„¸ìš”</h3>
      <div class="ad-placeholder" id="adPlaceholder">
        ê´‘ê³  ë¡œë”© ì¤‘...
      </div>
      <button onclick="closeAdModal()">ë‹«ê¸°</button>
    </div>
  </div>
  
  <!-- SQL API ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="../assets/js/sql-api.js"></script>
  <!-- í¬ì¸íŠ¸ ì‹œìŠ¤í…œ -->
  <script src="../assets/js/point-system.js"></script>
  
  <script>
    console.log('ë£°ë › ê²Œì„ ì‹œì‘!');
    
    // ê²Œì„ ìƒíƒœ
    let isSpinning = false;
    let remaining = 3;
    let selectedPrize = null;
    let prizes = [];
    
    // ê¸°ë³¸ ê²½í’ˆ ë°ì´í„°
    const defaultPrizes = [
      { name: "100í¬ì¸íŠ¸", probability: 30, points: 100 },
      { name: "200í¬ì¸íŠ¸", probability: 25, points: 200 },
      { name: "500í¬ì¸íŠ¸", probability: 20, points: 500 },
      { name: "1000í¬ì¸íŠ¸", probability: 15, points: 1000 },
      { name: "ê½", probability: 10, points: 0 }
    ];
    
    // DOM ìš”ì†Œë“¤
    const rouletteWheel = document.getElementById('rouletteWheel');
    const spinBtn = document.getElementById('spinBtn');
    const remainingAttempts = document.getElementById('remainingAttempts');
    const resultModal = document.getElementById('resultModal');
    const resultPrize = document.getElementById('resultPrize');
    const adModal = document.getElementById('adModal');
    const adPlaceholder = document.getElementById('adPlaceholder');
    
    // í¬ì¸íŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    let pointSystem = null;
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('DOM ë¡œë“œë¨, SQL APIë¡œ ê²Œì„ ì„¤ì • ë¡œë”© ì‹œì‘');
      
      try {
        // SQL APIë¡œ ê²Œì„ ì„¤ì • ë¡œë“œ
        const rouletteSettings = await window.sqlAPI.getGameSettings('roulette');
        console.log('ë£°ë › ì„¤ì • ë¡œë“œë¨:', rouletteSettings);
        
        if (rouletteSettings && rouletteSettings.prizes) {
          prizes = rouletteSettings.prizes;
          console.log('SQL APIì—ì„œ ê²½í’ˆ ë°ì´í„° ë¡œë“œ:', prizes);
        } else {
          console.log('ê²½í’ˆ ë°ì´í„°ê°€ ì—†ìŒ, ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©');
          prizes = defaultPrizes;
        }
        
        if (rouletteSettings && rouletteSettings.attempts) {
          remaining = rouletteSettings.attempts;
          console.log('SQL APIì—ì„œ ì‹œë„ íšŸìˆ˜ ë¡œë“œ:', remaining);
        } else {
          console.log('ì‹œë„ íšŸìˆ˜ ì„¤ì •ì´ ì—†ìŒ, ê¸°ë³¸ê°’ ì‚¬ìš©');
          remaining = 3;
        }
        
        // ì‹œë„ íšŸìˆ˜ UI ì—…ë°ì´íŠ¸
        if (remainingAttempts) {
          remainingAttempts.textContent = remaining;
        }
        
        // í¬ì¸íŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        if (window.PointSystem) {
          pointSystem = new window.PointSystem();
          console.log('í¬ì¸íŠ¸ ì‹œìŠ¤í…œ ë¡œë“œë¨');
        }
        
        // ë£°ë › íœ  ê·¸ë¦¬ê¸°
        drawRoulette();
        console.log('SQL API ê²Œì„ ì„¤ì • ë¡œë”© ì™„ë£Œ');
      } catch (error) {
        console.error('ê²Œì„ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
        
        // í´ë°±: ê¸°ë³¸ ì„¤ì • ì‚¬ìš©
        prizes = defaultPrizes;
        remaining = 3;
        if (remainingAttempts) {
          remainingAttempts.textContent = remaining;
        }
        
        drawRoulette();
        console.log('ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ í´ë°±');
      }
    });
    
    // ë£°ë › íœ  ê·¸ë¦¬ê¸°
    function drawRoulette() {
      const wheel = document.getElementById('rouletteWheel');
      wheel.innerHTML = '<div class="roulette-pointer"></div>';
      
      if (prizes.length === 0) return;
      
      const segmentAngle = 360 / prizes.length;
      
      prizes.forEach((prize, index) => {
        const segment = document.createElement('div');
        segment.className = 'roulette-segment';
        segment.style.transform = `rotate(${index * segmentAngle}deg)`;
        segment.style.background = prize.color || '#95a5a6';
        segment.textContent = prize.name;
        wheel.appendChild(segment);
      });
      
      console.log('ë£°ë › íœ  ê·¸ë¦¬ê¸° ì™„ë£Œ');
    }
    
    // ë£°ë › ëŒë¦¬ê¸°
    function spin() {
      if (isSpinning || remaining <= 0) return;
      
      console.log('ë£°ë › ëŒë¦¬ê¸° ì‹œì‘');
      isSpinning = true;
      spinBtn.disabled = true;
      spinBtn.textContent = 'ëŒë¦¬ëŠ” ì¤‘...';
      
      // ë£°ë › íšŒì „ ì• ë‹ˆë©”ì´ì…˜
      rouletteWheel.classList.add('spinning');
      
      // 4ì´ˆ í›„ ê²°ê³¼ ê²°ì •
      setTimeout(() => {
        selectPrize();
        rouletteWheel.classList.remove('spinning');
        showResult();
        isSpinning = false;
        spinBtn.disabled = false;
        spinBtn.textContent = 'ë£°ë › ëŒë¦¬ê¸°';
      }, 4000);
    }
    
    // ê²½í’ˆ ì„ íƒ
    function selectPrize() {
      const random = Math.random() * 100;
      let cumulative = 0;
      
      for (let prize of prizes) {
        cumulative += prize.probability;
        if (random <= cumulative) {
          selectedPrize = prize;
          break;
        }
      }
      
      console.log('ì„ íƒëœ ê²½í’ˆ:', selectedPrize);
    }
    
    // ê²°ê³¼ í‘œì‹œ
    function showResult() {
      remaining--;
      remainingAttempts.textContent = remaining;
      
      if (selectedPrize) {
        resultPrize.textContent = selectedPrize.name;
        
        // í¬ì¸íŠ¸ ì§€ê¸‰
        if (selectedPrize.points > 0 && pointSystem) {
          pointSystem.addPoints(selectedPrize.points, `ë£°ë › ê²Œì„: ${selectedPrize.name}`);
          console.log(`${selectedPrize.points}í¬ì¸íŠ¸ ì§€ê¸‰ë¨`);
        }
      }
      
      resultModal.style.display = 'block';
      
      // ì‹œë„ íšŸìˆ˜ í™•ì¸
      if (remaining <= 0) {
        setTimeout(() => {
          spinBtn.textContent = 'ì‹œë„ íšŸìˆ˜ ì´ˆê³¼';
          spinBtn.disabled = true;
        }, 1000);
      }
    }
    
    // ê²°ê³¼ ëª¨ë‹¬ ë‹«ê¸°
    function closeResultModal() {
      resultModal.style.display = 'none';
    }
    
    // ê´‘ê³  ëª¨ë‹¬ í‘œì‹œ
    function showAdModal() {
      resultModal.style.display = 'none';
      adModal.style.display = 'block';
      
      // AdSense ê´‘ê³  ë¡œë“œ
      setTimeout(() => {
        try {
          (adsbygoogle = window.adsbygoogle || []).push({});
          console.log('AdSense ê´‘ê³  ë¡œë“œë¨');
        } catch (error) {
          console.error('AdSense ì˜¤ë¥˜:', error);
        }
      }, 100);
      
      // 3ì´ˆ í›„ ê´‘ê³  ì™„ë£Œ ì²˜ë¦¬
      setTimeout(() => {
        adPlaceholder.textContent = 'ê´‘ê³  ì‹œì²­ ì™„ë£Œ!';
        adPlaceholder.style.background = '#d4edda';
        adPlaceholder.style.color = '#155724';
      }, 3000);
    }
    
    // ê´‘ê³  ëª¨ë‹¬ ë‹«ê¸°
    function closeAdModal() {
      adModal.style.display = 'none';
      
      // ê´‘ê³  ì‹œì²­ í›„ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ ì§€ê¸‰
      if (pointSystem) {
        pointSystem.addPoints(50, 'ê´‘ê³  ì‹œì²­ ë³´ë„ˆìŠ¤');
        console.log('ê´‘ê³  ì‹œì²­ ë³´ë„ˆìŠ¤ 50í¬ì¸íŠ¸ ì§€ê¸‰ë¨');
      }
      
      // ë£°ë › ëŒë¦¬ê¸°
      spin();
    }
    
    // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
    window.closeResultModal = closeResultModal;
    window.showAdModal = showAdModal;
    window.closeAdModal = closeAdModal;
  </script>
</body>
</html>