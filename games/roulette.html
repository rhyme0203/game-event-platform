<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>럭키빤쓰 - 행운의 룰렛</title>
  <link rel="stylesheet" href="../assets/css/common.css">
  <link rel="stylesheet" href="../assets/css/ads.css">
  <link rel="stylesheet" href="../assets/css/ad-modal.css">
  
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8451876651536601"
       crossorigin="anonymous"></script>
  <style>
    .roulette-container {
      position: relative;
      width: 400px;
      height: 400px;
      margin: 0 auto;
    }

    .roulette-wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      position: relative;
      transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
      box-shadow: 0 0 0 15px #fff, 0 0 0 18px var(--primary-color), 0 10px 50px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .roulette-canvas {
      width: 100%;
      height: 100%;
    }

    .roulette-pin {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-top: 35px solid var(--danger-color);
      z-index: 10;
      filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
    }

    .roulette-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      z-index: 5;
    }

    .spin-count {
      margin-top: 30px;
      font-size: 1.1em;
      color: #666;
      font-weight: 600;
    }

    .spin-count span {
      color: var(--primary-color);
      font-size: 1.3em;
      font-weight: 700;
    }

    @media (max-width: 600px) {
      .roulette-container {
        width: 300px;
        height: 300px;
      }
      .roulette-center {
        width: 60px;
        height: 60px;
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="game-card">
      <h1>🎡 행운의 룰렛</h1>
      <p class="subtitle">룰렛을 돌려 경품을 받아가세요!</p>

      <div class="game-area">
        <div class="roulette-container">
          <div class="roulette-pin"></div>
          <div class="roulette-wheel" id="wheel">
            <canvas id="rouletteCanvas" class="roulette-canvas"></canvas>
          </div>
          <div class="roulette-center">🎁</div>
        </div>
        
        <div class="spin-count">
          남은 기회: <span id="remaining">3</span>회
        </div>
      </div>

      <button class="start-button" id="spinBtn" onclick="showAdModal()">룰렛 돌리기</button>

      <div class="info-box">
        <p><strong>참여 방법</strong></p>
        <p>버튼을 눌러 룰렛을 돌리면 자동으로 경품이 추첨됩니다.</p>
        <p>하루 3회까지 참여 가능합니다.</p>
      </div>

      <a href="../index.html" class="back-link">← 메인으로 돌아가기</a>
    </div>
  </div>

  <!-- 결과 모달 -->
  <div class="result-modal" id="resultModal">
    <div class="result-content">
      <div class="result-icon">🎉</div>
      <div class="result-title">축하합니다!</div>
      <div class="result-prize" id="prizeText"></div>
      
      
      <button class="close-button" id="closeBtn">확인</button>
    </div>
  </div>

  <!-- 광고 모달 -->
  <div class="ad-modal" id="adModal">
    <div class="ad-modal-content">
      <button class="ad-modal-close" onclick="closeAdModalAndSpin()">&times;</button>
      
      <div class="ad-modal-header">
        <div class="ad-modal-title">🎯 특별 이벤트!</div>
        <div class="ad-modal-subtitle">럭키빤쓰 프리미엄 서비스를 확인해보세요</div>
      </div>
      
      <div class="ad-modal-body">
        <div class="ad-modal-ad">
          <!-- Google AdSense 광고 -->
          <ins class="adsbygoogle"
               style="display:block;width:300px;height:250px;"
               data-ad-client="ca-pub-8451876651536601"
               data-ad-slot="5939741579"></ins>
          <div class="ad-modal-ad-placeholder" style="display:none;">
            광고 로딩 중...
          </div>
        </div>
        
        <div class="ad-modal-countdown" id="countdown" style="display:none;">
          <span id="countdownText">5</span>초 후 게임 시작
        </div>
      </div>
      
      <div class="ad-modal-footer">
        <button class="ad-modal-btn ad-modal-btn-primary" onclick="startGame()" id="startGameBtn">
          게임 시작하기
        </button>
        <button class="ad-modal-btn ad-modal-btn-secondary" onclick="skipAd()">
          광고 건너뛰기
        </button>
      </div>
    </div>
  </div>

  <!-- 관리자 통합 스크립트 -->
  <script src="../assets/js/admin-integration.js"></script>
  
  <script>
    console.log('스크립트 로드됨!');
    
    // 경품 데이터
    const prizes = [
      { name: '1등: 스타벅스 기프티콘', color: '#ff6b6b', probability: 5 },
      { name: '꽝', color: '#95a5a6', probability: 25 },
      { name: '2등: 500 포인트', color: '#4ecdc4', probability: 15 },
      { name: '꽝', color: '#95a5a6', probability: 25 },
      { name: '3등: 100 포인트', color: '#f39c12', probability: 20 },
      { name: '4등: 쿠폰 5%', color: '#9b59b6', probability: 10 }
    ];

    let remaining = 3;
    let isSpinning = false;
    let currentRotation = 0;
    let currentAttempts = window.maxAttempts || 3;
    const maxAttempts = window.maxAttempts || 3;
    const spinDuration = window.spinDuration || 4000; // 4초

    // DOM 요소
    let wheel, canvas, ctx, spinBtn, resultModal, prizeText, closeBtn, remainingText;
    
    // spin 함수를 전역으로 선언
    window.spin = function() {
      console.log('=== spin() 함수 호출됨! ===');
      console.log('isSpinning:', isSpinning);
      console.log('remaining:', remaining);
      
      // 중복 실행 방지
      if (isSpinning) {
        console.log('이미 돌아가는 중입니다');
        return;
      }
      
      if (remaining <= 0) {
        console.log('참여 기회가 소진되었습니다');
        return;
      }
      
      isSpinning = true;
      if (spinBtn) {
        spinBtn.disabled = true;
        spinBtn.textContent = '돌아가는 중...';
      }
      
      const selectedIndex = selectPrize();
      const sectionAngle = 360 / prizes.length;
      
      // 최소 5바퀴 + 선택된 섹션으로 이동
      const minRotation = 360 * 5;
      const targetRotation = minRotation + (360 - (selectedIndex * sectionAngle)) - (sectionAngle / 2);
      currentRotation += targetRotation;
      
      console.log('회전 각도:', currentRotation);
      
      if (wheel) {
        wheel.style.transform = `rotate(${currentRotation}deg)`;
      }
      
      setTimeout(() => {
        isSpinning = false;
        remaining--;
        if (remainingText) remainingText.textContent = remaining;
        
        // 게임 플레이 기록
        if (window.adminIntegration) {
          window.adminIntegration.recordGamePlay('roulette', {
            won: selectedPrize.probability > 0,
            prize: selectedPrize.name,
            timestamp: new Date().toISOString()
          });
        }
        
        if (remaining > 0) {
          if (spinBtn) {
            spinBtn.disabled = false;
            spinBtn.textContent = '룰렛 돌리기';
          }
        } else {
          if (spinBtn) {
            spinBtn.textContent = '참여 기회 소진';
          }
        }
        
        showResult(prizes[selectedIndex].name);
      }, 4000);
    };

    // 페이지 로드 후 초기화
    window.addEventListener('DOMContentLoaded', function() {
      console.log('=== 페이지 로드 시작 ===');
      
      wheel = document.getElementById('wheel');
      canvas = document.getElementById('rouletteCanvas');
      spinBtn = document.getElementById('spinBtn');
      resultModal = document.getElementById('resultModal');
      prizeText = document.getElementById('prizeText');
      closeBtn = document.getElementById('closeBtn');
      remainingText = document.getElementById('remaining');

      console.log('wheel:', wheel);
      console.log('canvas:', canvas);
      console.log('spinBtn:', spinBtn);
      
      if (!canvas) {
        console.error('Canvas를 찾을 수 없습니다!');
        return;
      }
      
      ctx = canvas.getContext('2d');
      console.log('ctx:', ctx);

      // 이벤트 리스너 (룰렛 돌리기 버튼은 onclick으로 처리)
      console.log('버튼 이벤트 리스너는 onclick으로 처리됨');
      
      closeBtn.addEventListener('click', closeModal);
      resultModal.addEventListener('click', (e) => {
        if (e.target === resultModal) closeModal();
      });

      // 룰렛 초기화
      console.log('룰렛 초기화 시작');
      createWheel();
      console.log('=== 초기화 완료 ===');
    });

    // Canvas 크기 설정
    function setCanvasSize() {
      const size = wheel.offsetWidth;
      canvas.width = size;
      canvas.height = size;
      drawWheel();
    }

    // 룰렛 원판 그리기
    function drawWheel() {
      console.log('drawWheel 호출됨, canvas 크기:', canvas.width, 'x', canvas.height);
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = canvas.width / 2;
      const sectionAngle = (Math.PI * 2) / prizes.length;

      prizes.forEach((prize, index) => {
        const startAngle = index * sectionAngle - Math.PI / 2;
        const endAngle = startAngle + sectionAngle;

        // 섹션 그리기
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
        ctx.closePath();
        ctx.fillStyle = prize.color;
        ctx.fill();
        
        // 테두리
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 3;
        ctx.stroke();

        // 텍스트
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(startAngle + sectionAngle / 2);
        ctx.textAlign = 'center';
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 16px Pretendard, Arial, sans-serif';
        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
        ctx.shadowBlur = 4;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        ctx.fillText(prize.name, radius * 0.6, 5);
        ctx.restore();
      });
      
      console.log('원판 그리기 완료');
    }

    // 초기 설정
    function createWheel() {
      setTimeout(() => {
        setCanvasSize();
        window.addEventListener('resize', setCanvasSize);
      }, 100);
    }

    // 확률에 따른 경품 선택
    function selectPrize() {
      const totalProbability = prizes.reduce((sum, prize) => sum + prize.probability, 0);
      let random = Math.random() * totalProbability;
      
      for (let i = 0; i < prizes.length; i++) {
        random -= prizes[i].probability;
        if (random <= 0) {
          return i;
        }
      }
      return 0;
    }


    // 결과 표시
    function showResult(prize) {
      prizeText.textContent = prize;
      resultModal.classList.add('show');
    }

    // 모달 닫기
    function closeModal() {
      resultModal.classList.remove('show');
    }

    // Google AdSense 초기화 (중복 방지)
    if (typeof adsbygoogle !== 'undefined' && adsbygoogle.loaded) {
      // 이미 로드된 경우 스킵
    } else {
      (adsbygoogle = window.adsbygoogle || []).push({});
    }

    // 관리자 설정 적용
    window.addEventListener('DOMContentLoaded', function() {
      if (window.adminIntegration) {
        window.adminIntegration.applyRouletteSettings();
      }
    });
    
    // 광고 모달 표시
    function showAdModal() {
      console.log('광고 모달 표시');
      const modal = document.getElementById('adModal');
      modal.classList.add('show');
      
      // 카운트다운은 자동으로 시작하지 않음
      // 사용자가 "게임 시작하기" 버튼을 눌러야만 시작
    }
    
    // 광고 모달 닫기
    function closeAdModal() {
      const modal = document.getElementById('adModal');
      modal.classList.remove('show');
    }
    
    // 광고 모달 닫고 스핀 시작
    function closeAdModalAndSpin() {
      console.log('X 버튼으로 모달 닫기');
      closeAdModal();
      // 모달이 닫힌 후 스핀 시작
      setTimeout(() => {
        if (!isSpinning) {
          spin();
        }
      }, 300);
    }
    
    // 카운트다운 시작
    function startCountdown() {
      const countdown = document.getElementById('countdown');
      const countdownText = document.getElementById('countdownText');
      const startBtn = document.getElementById('startGameBtn');
      
      countdown.style.display = 'block';
      startBtn.style.display = 'none';
      
      let timeLeft = 5;
      countdownText.textContent = timeLeft;
      
      const timer = setInterval(() => {
        timeLeft--;
        countdownText.textContent = timeLeft;
        
        if (timeLeft <= 0) {
          clearInterval(timer);
          // 카운트다운 완료 후 모달 닫고 게임 시작
          closeAdModal();
          setTimeout(() => {
            if (!isSpinning) {
              spin();
            }
          }, 300);
        }
      }, 1000);
    }
    
    // 게임 시작
    function startGame() {
      console.log('게임 시작!');
      // 카운트다운 시작
      startCountdown();
    }
    
    // 광고 건너뛰기
    function skipAd() {
      console.log('광고 건너뛰기');
      closeAdModal();
      // 모달이 닫힌 후 스핀 시작
      setTimeout(() => {
        if (!isSpinning) {
          spin();
        }
      }, 300);
    }
    
    // 광고 클릭 추적
    function trackAdClick(adType) {
      console.log('광고 클릭:', adType);
      // Google Analytics 추적
      if (typeof gtag !== 'undefined') {
        gtag('event', 'ad_click', {
          'ad_type': adType,
          'page': window.location.pathname
        });
      }
    }
  </script>
</body>
</html>

